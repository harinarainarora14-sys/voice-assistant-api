<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Voice Assistant</title>
<style>
  * { box-sizing: border-box; margin: 0; padding: 0; }

  html, body {
    height: 100%;
    width: 100%;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: #0a0a0a;
    color: #fff;
    display: flex;
    flex-direction: column;
    overflow: hidden;
  }

  #chat-container {
    flex: 1;
    display: flex;
    flex-direction: column;
    padding: 8px;
    overflow-y: auto;
    background: #121212;
  }

  .bubble {
    margin: 6px 0;
    padding: 12px 16px;
    border-radius: 18px;
    max-width: 80%;
    word-wrap: break-word;
    font-size: 1rem;
    line-height: 1.4;
    transition: all 0.2s ease;
  }

  .user {
    background: linear-gradient(45deg, #0077cc, #00aaff);
    color: #fff;
    margin-left: auto;
    text-align: right;
    box-shadow: 0 4px 10px rgba(0,170,255,0.3);
  }

  .bot {
    background: #222;
    color: #fff;
    margin-right: auto;
    text-align: left;
    box-shadow: 0 4px 10px rgba(255,255,255,0.05);
  }

  #input-bar {
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
    padding: 6px;
    background: #1a1a1a;
    border-top: 1px solid #333;
    align-items: center;
  }

  #input-bar input {
    flex: 1 1 100%;
    padding: 10px;
    font-size: 1rem;
    border-radius: 8px;
    border: none;
    background: #222;
    color: #fff;
    outline: none;
  }

  #input-bar input::placeholder {
    color: #888;
  }

  #input-bar button {
    flex: 1 1 auto;
    padding: 10px 12px;
    font-size: 0.9rem;
    border-radius: 8px;
    border: none;
    background: #0077cc;
    color: #fff;
    cursor: pointer;
    min-width: 70px;
    transition: all 0.2s ease;
    white-space: nowrap;
  }

  #input-bar button:hover {
    background: #00aaff;
    transform: scale(1.05);
  }

  /* Small devices */
  @media (max-width: 480px) {
    .bubble { font-size: 0.875rem; padding: 8px 10px; max-width: 90%; }
    #input-bar input { font-size: 0.875rem; }
    #input-bar button { font-size: 0.8rem; padding: 8px 6px; min-width: 60px; }
  }

  /* Medium devices */
  @media (max-width: 768px) {
    .bubble { max-width: 85%; }
    #input-bar input { font-size: 0.95rem; }
  }

  /* iPad 9th Generation / tablet layout */
  @media (min-width: 768px) and (max-width: 1620px) {
    html, body {
      height: 100vh;
      width: 100vw;
      font-size: 1rem;
    }

    #chat-container {
      padding: 12px;
      max-width: 100%;
      flex: 1;
    }

    .bubble {
      max-width: 70%;
      font-size: 1.05rem;
      line-height: 1.5;
      padding: 12px 16px;
      margin: 6px 0;
    }

    #input-bar {
      padding: 10px;
      gap: 8px;
      flex-wrap: nowrap;
    }

    #input-bar input {
      flex: 1 1 auto;
      font-size: 1rem;
      padding: 12px;
    }

    #input-bar button {
      font-size: 0.95rem;
      padding: 12px 16px;
      min-width: 80px;
    }
  }

  /* Scrollbar styling */
  #chat-container::-webkit-scrollbar {
    width: 6px;
  }
  #chat-container::-webkit-scrollbar-thumb {
    background: #555;
    border-radius: 3px;
  }
</style>
</head>
<body>

<div id="chat-container"></div>

<div id="input-bar">
  <input id="input" type="text" placeholder="Type your message..." onkeydown="if(event.key==='Enter'){sendMessage();}">
  <button onclick="sendMessage()">Send</button>
  <button id="voiceToggleBtn" onclick="toggleVoice()">Voice: On</button>
  <button id="speechToggleBtn" onclick="toggleSpeech()">Speech: On</button>
</div>

<script>
let apiBase = localStorage.getItem("apiUrl") || "https://voice-assistant-api-yya9.onrender.com";
let voiceEnabled = true;
let speechEnabled = true;
let mic = null;
let utter = null;
let audioUnlocked = false;

// Unlock audio on first tap for iOS
document.body.addEventListener("click", () => {
  if (!audioUnlocked) {
    const unlockUtter = new SpeechSynthesisUtterance("Voice assistant activated");
    speechSynthesis.speak(unlockUtter);
    audioUnlocked = true;
  }
}, {once: true});

function addMessage(text, sender) {
  const container = document.getElementById("chat-container");
  const msg = document.createElement("div");
  msg.className = "bubble " + sender;
  msg.innerText = text;
  container.appendChild(msg);
  container.scrollTop = container.scrollHeight;
}

function formatTime12Hour() {
  const now = new Date();
  let hours = now.getHours();
  const minutes = now.getMinutes();
  const ampm = hours >= 12 ? 'PM' : 'AM';
  hours = hours % 12;
  if (hours === 0) hours = 12;
  const hh = hours.toString().padStart(2,'0');
  const mm = minutes.toString().padStart(2,'0');
  return `${hh}:${mm} ${ampm}`;
}

async function sendMessage() {
  const input = document.getElementById("input");
  const text = input.value.trim();
  if (!text) return;

  // Stop ongoing speech
  if (speechSynthesis.speaking) speechSynthesis.cancel();
  stopVoice();

  addMessage(text, "user");
  input.value = "";

  try {
    let answerText = "";

    if (text.toLowerCase().includes("time")) {
      answerText = formatTime12Hour();
    } else {
      const res = await fetch(apiBase + "/ask?question=" + encodeURIComponent(text));
      const data = await res.json();
      answerText = (data && data.answer) ? data.answer : "No answer received from API";
    }

    addMessage(answerText, "bot");
    if (speechEnabled && audioUnlocked) speak(answerText);
  } catch (err) {
    console.error(err);
    addMessage("Error connecting to API", "bot");
  }
}

function startVoice() {
  if (!voiceEnabled) return;
  if (!("webkitSpeechRecognition" in window)) {
    alert("Voice recognition not supported");
    return;
  }
  if (!mic) {
    mic = new webkitSpeechRecognition();
    mic.lang = "en-US";
    mic.continuous = false;
    mic.interimResults = false;

    mic.onstart = () => { if (speechSynthesis.speaking) speechSynthesis.cancel(); };
    mic.onresult = e => {
      document.getElementById("input").value = e.results[0][0].transcript;
      sendMessage();
    };
    mic.onerror = e => console.error(e);
    mic.onend = () => { mic = null; };
  }
  mic.start();
}

function stopVoice() {
  if(mic) {
    mic.onresult = null;
    mic.onerror = null;
    mic.stop();
    mic = null;
  }
}

function toggleVoice() {
  voiceEnabled = !voiceEnabled;
  document.getElementById("voiceToggleBtn").innerText = "Voice: " + (voiceEnabled ? "On" : "Off");
}

function toggleSpeech() {
  speechEnabled = !speechEnabled;
  document.getElementById("speechToggleBtn").innerText = "Speech: " + (speechEnabled ? "On" : "Off");
}

function speak(text) {
  if (speechSynthesis.speaking) speechSynthesis.cancel();
  utter = new SpeechSynthesisUtterance(text);
  speechSynthesis.speak(utter);
}

document.getElementById("input").addEventListener("focus", () => {
  if (voiceEnabled) startVoice();
});
</script>
</body>
</html>
