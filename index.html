<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Voice Assistant</title>
<style>
  body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: #0a0a0a;
    color: #fff;
    margin: 0;
    padding: 0;
    height: 100vh;
    display: flex;
    flex-direction: column;
  }

  #chat-container {
    flex: 1;
    display: flex;
    flex-direction: column;
    padding: 10px;
    overflow-y: auto;
    background: #121212;
  }

  .bubble {
    margin: 6px 0;
    padding: 12px 16px;
    border-radius: 18px;
    max-width: 75%;
    word-wrap: break-word;
    font-size: 16px;
    line-height: 1.4;
    transition: all 0.2s ease;
  }

  .user {
    background: linear-gradient(45deg, #0077cc, #00aaff);
    color: #fff;
    margin-left: auto;
    text-align: right;
    box-shadow: 0 4px 10px rgba(0,170,255,0.3);
  }

  .bot {
    background: #222;
    color: #fff;
    margin-right: auto;
    text-align: left;
    box-shadow: 0 4px 10px rgba(255,255,255,0.05);
  }

  #input-bar {
    display: flex;
    gap: 8px;
    padding: 10px;
    background: #1a1a1a;
    border-top: 1px solid #333;
    align-items: center;
    position: sticky;
    bottom: 0;
    z-index: 10;
  }

  #input-bar input {
    flex: 1;
    padding: 12px;
    font-size: 16px;
    border-radius: 8px;
    border: none;
    background: #222;
    color: #fff;
    outline: none;
  }

  #input-bar input::placeholder {
    color: #888;
  }

  #input-bar button {
    padding: 12px 14px;
    font-size: 16px;
    border-radius: 8px;
    border: none;
    background: #0077cc;
    color: #fff;
    cursor: pointer;
    transition: all 0.2s ease;
    white-space: nowrap;
  }

  #input-bar button:hover {
    background: #00aaff;
    transform: scale(1.05);
  }

  @media (max-width: 480px) {
    .bubble { font-size: 14px; padding: 10px 12px; }
    #input-bar input { font-size: 14px; }
    #input-bar button { font-size: 14px; padding: 10px 10px; }
  }
</style>
</head>
<body>

<div id="chat-container"></div>

<div id="input-bar">
  <input id="input" type="text" placeholder="Type your message..." onkeydown="if(event.key==='Enter'){sendMessage();}">
  <button onclick="sendMessage()">Send</button>
  <button id="voiceToggleBtn" onclick="toggleVoice()">Voice: On</button>
  <button id="speechToggleBtn" onclick="toggleSpeech()">Speech: On</button>
</div>

<script>
let apiBase = localStorage.getItem("apiUrl") || "https://voice-assistant-api-yya9.onrender.com";
let voiceEnabled = true; 
let speechEnabled = true; 
let mic = null;
let utter = null;
let audioUnlocked = false;

// Unlock audio for iOS Safari
document.body.addEventListener("click", () => {
  if (!audioUnlocked) {
    const unlockUtter = new SpeechSynthesisUtterance("Voice assistant activated");
    speechSynthesis.speak(unlockUtter);
    audioUnlocked = true;
  }
}, {once: true});

// Chat message append
function addMessage(text, sender) {
  const container = document.getElementById("chat-container");
  const msg = document.createElement("div");
  msg.className = "bubble " + sender;
  msg.innerText = text;
  container.appendChild(msg);
  container.scrollTop = container.scrollHeight;
}

// Convert TIME to 12-hour format hh:mm AM/PM
function formatTime12Hour() {
  const now = new Date();
  let hours = now.getHours();
  const minutes = now.getMinutes();
  const ampm = hours >= 12 ? 'PM' : 'AM';
  hours = hours % 12;
  if (hours === 0) hours = 12;
  const hh = hours.toString().padStart(2,'0');
  const mm = minutes.toString().padStart(2,'0');
  return `${hh}:${mm} ${ampm}`;
}

// Send message to API
async function sendMessage() {
  const input = document.getElementById("input");
  const text = input.value.trim();
  if (!text) return;

  stopVoice(); // stop mic when sending

  addMessage(text, "user");
  input.value = "";

  try {
    let answerText = "";

    // Check if the user asked for time
    if (text.toLowerCase().includes("time")) {
      answerText = formatTime12Hour();
    } else {
      const res = await fetch(apiBase + "/ask?question=" + encodeURIComponent(text));
      const data = await res.json();
      if (data && data.answer) {
        answerText = data.answer;
      } else {
        answerText = "No answer received from API";
      }
    }

    addMessage(answerText, "bot");
    if (speechEnabled && audioUnlocked) speak(answerText);
  } catch (err) {
    console.error(err);
    addMessage("Error connecting to API", "bot");
  }
}

// Voice recognition
function startVoice() {
  if (!voiceEnabled) return;
  if (!("webkitSpeechRecognition" in window)) {
    alert("Voice recognition not supported");
    return;
  }

  if (!mic) {
    mic = new webkitSpeechRecognition();
    mic.lang = "en-US";
    mic.continuous = false;
    mic.interimResults = false;

    mic.onstart = () => {
      if (speechSynthesis.speaking) speechSynthesis.cancel();
    };

    mic.onresult = e => {
      document.getElementById("input").value = e.results[0][0].transcript;
      sendMessage();
    };

    mic.onerror = e => console.error(e);

    mic.onend = () => {
      mic = null; // reset mic after stop
    };
  }

  mic.start();
}

// Stop voice recognition
function stopVoice() {
  if(mic) {
    mic.onresult = null;
    mic.onerror = null;
    mic.stop();
    mic = null;
  }
}

// Toggle voice input
function toggleVoice() {
  voiceEnabled = !voiceEnabled;
  document.getElementById("voiceToggleBtn").innerText = "Voice: " + (voiceEnabled ? "On" : "Off");
}

// Toggle speech output
function toggleSpeech() {
  speechEnabled = !speechEnabled;
  document.getElementById("speechToggleBtn").innerText = "Speech: " + (speechEnabled ? "On" : "Off");
}

// Speak function
function speak(text) {
  if (speechSynthesis.speaking) speechSynthesis.cancel();
  utter = new SpeechSynthesisUtterance(text);
  speechSynthesis.speak(utter);
}

// Automatically start voice recognition when focusing input
document.getElementById("input").addEventListener("focus", () => {
  if (voiceEnabled) startVoice();
});
</script>
</body>
</html>
